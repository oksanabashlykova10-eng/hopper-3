<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–†–µ–¥–∞–∫—Ç–æ—Ä Leap & Learn</title>
<style>
    :root { --primary: #7cf9ff; --bg: #0a1730; --panel: #142545; --text: #eaf6ff; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
    
    /* SIDEBAR */
    #editor { width: 400px; background: var(--panel); border-right: 1px solid #334; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.3); z-index: 10; }
    .header { padding: 20px; background: #081022; border-bottom: 1px solid #334; position: sticky; top: 0; z-index: 20; }
    .header h2 { margin: 0; color: var(--primary); font-size: 22px; text-transform: uppercase; letter-spacing: 1px; }
    
    .section { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .section-title { font-weight: bold; margin-bottom: 10px; color: #bfe9ff; display: flex; justify-content: space-between; cursor: pointer; }
    .section-content { display: flex; flex-direction: column; gap: 10px; }
    .collapsed .section-content { display: none; }
    
    label { font-size: 13px; opacity: 0.8; margin-bottom: 2px; display: block; }
    input, select, textarea { background: rgba(0,0,0,0.3); border: 1px solid #456; color: white; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    input[type="color"] { height: 40px; padding: 2px; cursor: pointer; }
    
    .row { display: flex; gap: 10px; }
    .btn { background: var(--primary); color: #000; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    .btn-danger { background: #ff3b3b; color: white; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    /* LEVELS EDITOR */
    .level-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
    .q-item { background: rgba(0,0,0,0.3); padding: 8px; margin-top: 5px; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--panel); padding: 20px; width: 500px; border-radius: 8px; border: 1px solid var(--primary); box-shadow: 0 0 30px rgba(0,0,0,0.5); }

    /* PREVIEW */
    #preview-container { flex: 1; position: relative; background: #000; }
    iframe { width: 100%; height: 100%; border: none; }
    
    /* COPY OVERLAY */
    #copy-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 50; text-align: center; }
    #copy-overlay h3 { color: var(--primary); }
    #generated-code { width: 80%; height: 200px; margin: 20px 0; font-family: monospace; font-size: 11px; }

    /* PRESETS */
    .preset-img { width: 40px; height: 40px; border: 2px solid transparent; border-radius: 4px; cursor: pointer; object-fit: cover; background: #fff; }
    .preset-img.active { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
    .presets-row { display: flex; gap: 8px; margin-bottom: 8px; }
</style>
</head>
<body>

<div id="editor">
    <div class="header">
        <h2>Leap & Learn Editor</h2>
        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">–ù–∞—Å—Ç—Ä–æ–π –∏ –≤—Å—Ç–∞–≤—å –≤ Genially</div>
    </div>

    <div class="section">
        <div class="section-title" onclick="toggleSection(this)">üé® –í–∏–∑—É–∞–ª –∏ –§–æ–Ω <span>‚ñº</span></div>
        <div class="section-content">
            <label>–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (–ù–µ–æ–Ω)</label>
            <div class="row">
                <input type="color" id="conf-neon" value="#7cf9ff" onchange="updatePreview()">
                <input type="text" id="conf-neon-txt" value="#7cf9ff" onchange="syncColor('conf-neon', this.value); updatePreview()">
            </div>

            <label>–§–æ–Ω (–õ–æ–∫–∞—Ü–∏—è)</label>
            <div class="presets-row" id="bg-presets">
                </div>
            <input type="text" id="conf-bg" placeholder="–ò–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É..." onchange="updatePreview()">

            <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
            <div class="presets-row" id="char-presets"></div>
            <input type="hidden" id="conf-char">

            <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
            <div class="presets-row" id="plat-presets"></div>
            <input type="hidden" id="conf-plat">
            
            <label>–®—Ä–∏—Ñ—Ç (–†–∞–∑–º–µ—Ä px)</label>
            <div class="row">
                <input type="number" id="conf-fs" value="40" onchange="updatePreview()">
                <input type="color" id="conf-fc" value="#0b1630" onchange="updatePreview()">
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title" onclick="toggleSection(this)">‚öôÔ∏è –ì–µ–π–º–ø–ª–µ–π <span>‚ñº</span></div>
        <div class="section-content">
            <label>–¢–∞–π–º–µ—Ä (–°–µ–∫—É–Ω–¥—ã –¥–ª—è —É—Ä–æ–≤–Ω–µ–π 1, 2, 3+)</label>
            <div class="row">
                <input type="number" id="time1" value="10" placeholder="Lvl 1">
                <input type="number" id="time2" value="7" placeholder="Lvl 2">
                <input type="number" id="time3" value="5" placeholder="Lvl 3">
            </div>
            
            <label>–¶–≤–µ—Ç —Ç–∞–π–º–µ—Ä–∞</label>
            <input type="color" id="conf-timer-col" value="#ffffff" onchange="updatePreview()">

            <label>–°–æ–æ–±—â–µ–Ω–∏—è –§–∏–Ω–∞–ª–∞</label>
            <input type="text" id="msg-win" value="YOU WON!" placeholder="–ü–æ–±–µ–¥–∞">
            <input type="text" id="msg-lose" value="GAME OVER" placeholder="–ü—Ä–æ–∏–≥—Ä—ã—à">
        </div>
    </div>

    <div class="section">
        <div class="section-title" onclick="toggleSection(this)">üéµ –ó–≤—É–∫–∏ (–°—Å—ã–ª–∫–∏ mp3) <span>‚ñº</span></div>
        <div class="section-content collapsed">
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
            <input type="text" id="snd-ok" placeholder="http://...">
            <label>–û—à–∏–±–∫–∞</label>
            <input type="text" id="snd-bad" placeholder="http://...">
            <label>–ü–æ–±–µ–¥–∞</label>
            <input type="text" id="snd-win" placeholder="http://...">
            <label>–ü—Ä–æ–≤–∞–ª</label>
            <input type="text" id="snd-lose" placeholder="http://...">
            <small style="opacity:0.5">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–≤—É–∫–æ–≤</small>
        </div>
    </div>

    <div class="section">
        <div class="section-title" onclick="toggleSection(this)">üìö –£—Ä–æ–≤–Ω–∏ –∏ –í–æ–ø—Ä–æ—Å—ã <span>‚ñº</span></div>
        <div class="section-content">
            <div id="levels-container"></div>
            <button class="btn btn-outline btn-sm" onclick="addLevel()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
        </div>
    </div>

    <div class="section">
        <button class="btn" style="width:100%" onclick="generateFinalCode()">üöÄ –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î –î–õ–Ø GENIALLY</button>
    </div>
</div>

<div id="preview-container">
    <iframe id="gameFrame"></iframe>
</div>

<div id="qModal" class="modal">
    <div class="modal-content">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å</h3>
        <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
        <input type="text" id="m-text">
        
        <label>–í–∞—Ä–∏–∞–Ω—Ç—ã (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–µ—Ä–∏ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–æ–π)</label>
        <div style="display:grid; gap:5px; margin-bottom:10px;">
            <div class="row"><input type="radio" name="m-corr" value="0" checked> <input type="text" id="m-a0" placeholder="–û—Ç–≤–µ—Ç 1"></div>
            <div class="row"><input type="radio" name="m-corr" value="1"> <input type="text" id="m-a1" placeholder="–û—Ç–≤–µ—Ç 2"></div>
            <div class="row"><input type="radio" name="m-corr" value="2"> <input type="text" id="m-a2" placeholder="–û—Ç–≤–µ—Ç 3"></div>
        </div>

        <div class="row" style="justify-content: flex-end;">
            <button class="btn btn-danger btn-sm" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-sm" onclick="saveQuestion()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="copy-overlay">
    <h3>–ö–æ–¥ –≥–æ—Ç–æ–≤!</h3>
    <p style="color:#ccc">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —ç–ª–µ–º–µ–Ω—Ç "Insert > Others" –≤ Genially.</p>
    <textarea id="generated-code"></textarea>
    <div class="row">
        <button class="btn" onclick="copyToClipboard()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn btn-outline" onclick="document.getElementById('copy-overlay').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
/* ================= DATA & ASSETS ================= */
const ASSETS = {
    bg: [
        {name:'–†–µ–∫–∞', url:'https://img.genially.com/67961b32a116fb001568a75e/c0c9010f-c3dd-42c1-b7c1-65024fa3aec6.png'},
        {name:'–õ–∞–≤–∞', url:'https://img.genially.com/67961b32a116fb001568a75e/fa2ab459-fec9-4ccd-97e3-254427b4ade0.png'},
        {name:'–ë–æ–ª–æ—Ç–æ', url:'https://img.genially.com/67961b32a116fb001568a75e/02b52ad4-9d31-4b21-a305-8fec6e8a4487.png'}
    ],
    chars: [
        {name:'–õ—è–≥—É—à–∫–∞', url:'https://img.genially.com/67961b32a116fb001568a75e/3074df22-5c73-4ad2-b0b2-491c6fc247f3.png'},
        {name:'–•–∞–º–µ–ª–µ–æ–Ω', url:'https://img.genially.com/67961b32a116fb001568a75e/74b56fcf-5354-43dd-9c9a-f50facc9a9bf.png'},
        {name:'–Ø—â–µ—Ä–∏—Ü–∞', url:'https://img.genially.com/67961b32a116fb001568a75e/0feda2a1-485a-4654-8640-bf1adcc9f9ec.png'}
    ],
    plats: [
        {name:'–õ–∏–ª–∏—è', url:'https://img.genially.com/67961b32a116fb001568a75e/ed6c6e82-953b-43d4-947d-e46227b760f0.png'},
        {name:'–ö–∞–º–µ–Ω—å', url:'https://img.genially.com/67961b32a116fb001568a75e/bad37c6d-f04c-45c0-b954-807d79ec3a95.png'},
        {name:'–ö–æ—á–∫–∞', url:'https://img.genially.com/67961b32a116fb001568a75e/c6775617-bde5-43e4-9da8-5332d928807e.png'}
    ]
};

// Start State
let gameLevels = [
    { name: "Level 1", questions: [{text:"2 + 2 = ?", answers:["3","4","5"], correct:1}] }
];
let editingLevelIdx = -1;
let editingQIdx = -1;

/* ================= INITIALIZATION ================= */
function init() {
    createPresets('bg-presets', ASSETS.bg, 'conf-bg');
    createPresets('char-presets', ASSETS.chars, 'conf-char');
    createPresets('plat-presets', ASSETS.plats, 'conf-plat');
    
    // Select defaults
    selectPreset('bg-presets', 0);
    selectPreset('char-presets', 0);
    selectPreset('plat-presets', 0);

    renderLevels();
    updatePreview();
}

function createPresets(containerId, items, inputId) {
    const c = document.getElementById(containerId);
    const inp = document.getElementById(inputId);
    items.forEach((item, idx) => {
        const img = document.createElement('img');
        img.src = item.url;
        img.className = 'preset-img';
        img.title = item.name;
        img.onclick = () => {
            // Remove active from siblings
            Array.from(c.children).forEach(ch => ch.classList.remove('active'));
            img.classList.add('active');
            inp.value = item.url;
            updatePreview();
        };
        c.appendChild(img);
    });
}

function selectPreset(containerId, idx) {
    const c = document.getElementById(containerId);
    if(c.children[idx]) c.children[idx].click();
}

function toggleSection(el) {
    el.nextElementSibling.classList.toggle('collapsed'); // In CSS logic this hides it, need to flip
    if(el.parentElement.querySelector('.section-content').style.display === 'none') {
        el.parentElement.querySelector('.section-content').style.display = 'flex';
    } else {
       // el.parentElement.querySelector('.section-content').style.display = 'none';
    }
}

function syncColor(id, val) { document.getElementById(id).value = val; }

/* ================= LEVEL EDITOR LOGIC ================= */
function renderLevels() {
    const c = document.getElementById('levels-container');
    c.innerHTML = '';
    
    gameLevels.forEach((lvl, lIdx) => {
        const div = document.createElement('div');
        div.className = 'level-card';
        
        let qHtml = '';
        lvl.questions.forEach((q, qIdx) => {
            qHtml += `
            <div class="q-item">
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">${q.text}</span>
                <div>
                    <button class="btn-sm btn-outline" onclick="editQ(${lIdx}, ${qIdx})">‚úèÔ∏è</button>
                    <button class="btn-sm btn-danger" onclick="delQ(${lIdx}, ${qIdx})">√ó</button>
                </div>
            </div>`;
        });

        div.innerHTML = `
            <div class="row" style="justify-content:space-between; margin-bottom:5px;">
                <input type="text" value="${lvl.name}" onchange="gameLevels[${lIdx}].name = this.value; updatePreview()" style="width:70%; font-weight:bold;">
                <button class="btn-sm btn-danger" onclick="delLevel(${lIdx})">üóë</button>
            </div>
            <div>${qHtml}</div>
            <button class="btn-sm btn-outline" style="width:100%; margin-top:5px;" onclick="addQ(${lIdx})">+ –í–æ–ø—Ä–æ—Å</button>
        `;
        c.appendChild(div);
    });
}

function addLevel() {
    gameLevels.push({ name: `Level ${gameLevels.length+1}`, questions: [] });
    renderLevels();
    updatePreview();
}
function delLevel(idx) {
    if(confirm('–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å?')) {
        gameLevels.splice(idx, 1);
        renderLevels();
        updatePreview();
    }
}

/* Question Modal Logic */
function addQ(lIdx) {
    editingLevelIdx = lIdx;
    editingQIdx = -1; // new
    openModal({text:"", answers:["","",""], correct:0});
}
function editQ(lIdx, qIdx) {
    editingLevelIdx = lIdx;
    editingQIdx = qIdx;
    openModal(gameLevels[lIdx].questions[qIdx]);
}
function delQ(lIdx, qIdx) {
    gameLevels[lIdx].questions.splice(qIdx, 1);
    renderLevels();
    updatePreview();
}

function openModal(data) {
    document.getElementById('m-text').value = data.text;
    document.getElementById('m-a0').value = data.answers[0];
    document.getElementById('m-a1').value = data.answers[1];
    document.getElementById('m-a2').value = data.answers[2];
    const radios = document.getElementsByName('m-corr');
    radios[data.correct].checked = true;
    document.getElementById('qModal').classList.add('active');
}
function closeModal() { document.getElementById('qModal').classList.remove('active'); }

function saveQuestion() {
    const text = document.getElementById('m-text').value;
    const ans = [
        document.getElementById('m-a0').value,
        document.getElementById('m-a1').value,
        document.getElementById('m-a2').value
    ];
    let correct = 0;
    document.getElementsByName('m-corr').forEach((r, i) => { if(r.checked) correct = i; });

    if(!text || ans.some(a=>!a)) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }

    const newQ = { text, answers: ans, correct };

    if(editingQIdx === -1) {
        gameLevels[editingLevelIdx].questions.push(newQ);
    } else {
        gameLevels[editingLevelIdx].questions[editingQIdx] = newQ;
    }
    
    closeModal();
    renderLevels();
    updatePreview();
}


/* ================= GENERATOR ENGINE ================= */
// Takes the provided game code template and injects variables
function getGameHTML() {
    // 1. Get Values
    const neon = document.getElementById('conf-neon').value;
    const bg = document.getElementById('conf-bg').value;
    const charUrl = document.getElementById('conf-char').value;
    const platUrl = document.getElementById('conf-plat').value;
    const fontSize = document.getElementById('conf-fs').value;
    const fontColor = document.getElementById('conf-fc').value;
    const tmrColor = document.getElementById('conf-timer-col').value;
    
    const t1 = document.getElementById('time1').value || 10;
    const t2 = document.getElementById('time2').value || 7;
    const t3 = document.getElementById('time3').value || 5;

    const msgWin = document.getElementById('msg-win').value;
    const msgLose = document.getElementById('msg-lose').value;

    const snd = {
        ok: document.getElementById('snd-ok').value,
        bad: document.getElementById('snd-bad').value,
        win: document.getElementById('snd-win').value,
        lose: document.getElementById('snd-lose').value
    };

    const levelsJson = JSON.stringify(gameLevels);

    // 2. Base Template (Minified version of user's code with injections)
    // Note: I am inserting the user's provided CSS/JS structure but replacing keys
    
    return `
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Leap & Learn</title>
<style>
:root{
  --neon-main:${neon};
  --danger:#ff3b3b;
  --win:#ffe44d;
}
html,body{margin:0;width:100%;height:100%;overflow:hidden;font-family:Arial;background:#0a1730}
#GAME{position:relative;width:100%;height:100%}
#GAME.shake{animation:shake .25s}
@keyframes shake{0%{transform:translate(0)}25%{transform:translate(-4px,3px)}50%{transform:translate(4px,-3px)}75%{transform:translate(-3px,2px)}100%{transform:translate(0)}}
#BG{position:absolute;inset:0;z-index:0;background:url("${bg}") center/cover no-repeat}

/* UI */
#SCORE{position:absolute;top:30px;left:30px;font-size:20px;font-weight:900;z-index:20;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
#TIMER{
 position:absolute;top:26px;left:120px;
 height:38px;border-radius:18px;
 display:flex;align-items:center;justify-content:center;gap:10px;
 padding:0 14px;
 background:${tmrColor};
 border:2px solid var(--neon-main);
 box-shadow:0 0 18px var(--neon-main);
 z-index:20;font-weight:900;color:#053149;
}
#TIMER.danger{border-color:var(--danger);color:var(--danger);box-shadow:0 0 25px var(--danger);animation:timerPulse .8s infinite;}
@keyframes timerPulse{50%{transform:scale(1.07)}}
#LIVES{position:absolute;top:30px;right:30px;font-size:26px;z-index:20}

#QUESTION{position:absolute;top:18px;width:100%;display:flex;justify-content:center;z-index:20;}
#QUESTION_TXT{
  font-size:${fontSize}px;
  color:${fontColor};
  font-weight:900;padding:10px 18px;border-radius:18px;background:rgba(255,255,255,.9);
  border:1px solid var(--neon-main); box-shadow:0 0 18px rgba(124,249,255,.25);
  text-shadow:0 2px 0 rgba(255,255,255,.5);
}

#COMBO{position:absolute;top:165px;left:50%;transform:translateX(-50%);z-index:20;padding:10px 16px;border-radius:18px;background:rgba(255,255,255,.88);border:2px solid var(--neon-main);box-shadow:0 0 18px rgba(124,249,255,.65);font-weight:900;color:#043149;display:none;gap:10px;align-items:center}
#COMBO.show{display:inline-flex}
#COMBO.pulse{animation:comboPulse .55s ease}
@keyframes comboPulse{0%{transform:translateX(-50%) translateY(10px) scale(.92);opacity:0}40%{transform:translateX(-50%) translateY(0px) scale(1.14);opacity:1}100%{transform:translateX(-50%) translateY(0px) scale(1);opacity:1}}

.btn{padding:12px 34px;border-radius:16px;font-weight:900;background:#fff;border:2px solid var(--neon-main);box-shadow:0 0 15px var(--neon-main);cursor:pointer;color:#043149;}
.btn:active{transform:translateY(1px)}
.btn.dark{background:rgba(255,255,255,.10);color:#eaf6ff;border:2px solid rgba(124,249,255,.55);}
#START.hide{display:none}

/* START SCREEN */
#START_SCREEN{position:absolute;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:rgba(8,16,34,.92);}
#START_CARD{width:min(760px, calc(100vw - 40px));border-radius:26px;background:linear-gradient(180deg,rgba(10,20,50,.92), rgba(5,10,25,.92));border:2px solid var(--neon-main);box-shadow:0 0 30px rgba(124,249,255,.55);padding:18px;color:#eaf6ff;}
#START_ICON{width:64px;height:64px;background:url("${charUrl}") center/contain no-repeat;}
#START_TITLE{font-weight:900;font-size:34px;color:var(--neon-main);text-shadow:0 0 18px var(--neon-main);margin:0;}
.panel{background:rgba(255,255,255,.08);border:1px solid rgba(124,249,255,.35);border-radius:18px;padding:12px;margin-top:10px;}

/* END */
#END{position:absolute;inset:0;z-index:50;background:rgba(8,16,34,.92);display:none;align-items:center;justify-content:center;flex-direction:column;}
#END.show{display:flex}
#END_TEXT{font-size:58px;font-weight:900;margin:0 0 10px;text-align:center;color:#fff;}
.win{color:var(--win);text-shadow:0 0 12px var(--win)}
.lose{color:var(--danger);text-shadow:0 0 12px var(--danger)}
#SCORECARD{width:min(620px,calc(100vw - 40px));background:rgba(255,255,255,.1);border:2px solid var(--neon-main);border-radius:22px;padding:18px;margin:16px 0;color:#fff;}

/* CHAR & PLATFORMS */
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
#FROG_WRAP{position:absolute;left:calc(160px - 17mm + 15mm - 11mm);top:calc(50% + 13mm - 11mm);width:110px;height:110px;z-index:15;pointer-events:none;animation:float 3.5s ease-in-out infinite;}
#FROG{width:110px;height:110px;background:url("${charUrl}") center/contain no-repeat;position:absolute;left:50%;top:50%;transform:translate(-50%,-65%);transition:transform .6s ease,opacity .6s ease;}
#FROG.jump{transform:translate(-50%,-95%) scale(1.05)}
#FROG.sink{transform:translate(-50%,-10%) scale(.6);opacity:0}

#PLATFORMS{position:absolute;inset:0;z-index:10}
.platform{position:absolute;width:150px;height:150px;transition:transform .5s,opacity .6s}
.lily{width:150px;height:150px;background:url("${platUrl}") center/contain no-repeat;display:flex;align-items:center;justify-content:center;font-weight:900;color:#141414;text-shadow:0 2px 0 rgba(255,255,255,.65);animation:float 3.5s ease-in-out infinite;cursor:pointer;}
.platform.wrong .lily{filter:drop-shadow(0 0 18px red)}
</style>
</head>
<body>
<div id="GAME">
  <div id="BG"></div>
  <div id="SCORE">‚≠ê 0</div>
  <div id="TIMER"><span id="TIMER_TXT">00:00</span></div>
  <div id="QUESTION"><div id="QUESTION_TXT"></div></div>
  <div id="COMBO"><span id="COMBO_TXT">COMBO x1.0</span></div>
  <div id="LIVES"></div>
  
  <div id="START_SCREEN">
    <div id="START_CARD">
      <div style="display:flex;gap:15px;align-items:center">
        <div id="START_ICON"></div>
        <div>
           <h1 id="START_TITLE">Leap & Learn</h1>
           <div>Quiz Game</div>
        </div>
      </div>
      <div class="panel">
        <ul style="color:#cfefff;font-weight:700"><li>–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.</li><li>–°–ª–µ–¥–∏ –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º!</li></ul>
      </div>
      <div style="margin-top:20px; text-align:center">
        <button id="START_BTN" class="btn">‚ñ∂ START GAME</button>
      </div>
    </div>
  </div>

  <div id="END">
    <div id="END_TEXT"></div>
    <div id="SCORECARD">
        <h2 style="margin:0;text-align:center" id="FINAL_SCORE">0</h2>
    </div>
    <div style="display:flex;gap:10px">
        <button id="NEXT_LEVEL" class="btn">Next Level</button>
        <button id="RETRY" class="btn">Play Again</button>
    </div>
  </div>
  
  <div id="FROG_WRAP"><div id="FROG"></div></div>
  <div id="PLATFORMS"></div>
</div>

<script>
/* INJECTED DATA */
const LEVELS = ${levelsJson};
const TIMES = {t1:${t1}, t2:${t2}, t3:${t3}};
const TEXTS = {win:"${msgWin}", lose:"${msgLose}"};
const SOUNDS = {
  ok: "${snd.ok}", bad: "${snd.bad}", win: "${snd.win}", lose: "${snd.lose}"
};

/* ENGINE */
let lvlIdx=0, qIdx=0, score=0, lives=3, timer=null;
let combo=0;

const Q_TXT = document.getElementById("QUESTION_TXT");
const PLAT = document.getElementById("PLATFORMS");
const FROG = document.getElementById("FROG");

document.getElementById("START_BTN").onclick = () => startGame();
document.getElementById("NEXT_LEVEL").onclick = () => { lvlIdx++; startLevel(); };
document.getElementById("RETRY").onclick = () => location.reload();

function playAudio(type){
    if(SOUNDS[type] && SOUNDS[type].length > 4) {
        new Audio(SOUNDS[type]).play().catch(e=>console.log(e));
    } else {
        // Fallback simple synths
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        if(type=='ok') { osc.frequency.value=600; g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.5); osc.start(); osc.stop(ctx.currentTime+0.5); }
        if(type=='bad') { osc.type='sawtooth'; osc.frequency.value=150; g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.5); osc.start(); osc.stop(ctx.currentTime+0.5); }
    }
}

function startGame(){
    document.getElementById("START_SCREEN").style.display="none";
    lvlIdx=0; score=0; lives=3;
    updateLives();
    startLevel();
}

function updateLives(){ document.getElementById("LIVES").innerHTML = "‚ù§Ô∏è".repeat(lives); }

function startLevel(){
    if(lvlIdx >= LEVELS.length) { showEnd(true, true); return; }
    document.getElementById("END").classList.remove("show");
    qIdx = 0;
    loadQuestion();
}

function loadQuestion(){
    if(qIdx >= LEVELS[lvlIdx].questions.length) {
        // Level Complete
        document.getElementById("END_TEXT").innerHTML = "Level Complete!";
        document.getElementById("END_TEXT").className = "win";
        document.getElementById("FINAL_SCORE").innerText = "Score: " + score;
        document.getElementById("END").classList.add("show");
        document.getElementById("NEXT_LEVEL").style.display = "block";
        document.getElementById("RETRY").style.display = "none";
        return;
    }

    const q = LEVELS[lvlIdx].questions[qIdx];
    Q_TXT.innerText = q.text;
    
    // Timer
    let t = lvlIdx===0 ? TIMES.t1 : (lvlIdx===1 ? TIMES.t2 : TIMES.t3);
    document.getElementById("TIMER_TXT").innerText = "00:" + (t<10?"0"+t:t);
    clearInterval(timer);
    timer = setInterval(()=>{
        t--;
        document.getElementById("TIMER_TXT").innerText = "00:" + (t<10?"0"+t:t);
        if(t<=0) handleAnswer(-1);
    }, 1000);

    // Platforms
    PLAT.innerHTML = "";
    // Shuffle positions visual only (simplified for iframe logic)
    const positions = [50, 200, 350]; // Y positions relative
    
    q.answers.forEach((ans, i) => {
        const p = document.createElement("div");
        p.className = "platform lily";
        p.style.left = (200 + i*180) + "px"; // Simple horizontal spread
        p.style.top = (window.innerHeight/2 + 50) + "px";
        p.innerHTML = "<span style='z-index:5;pointer-events:none'>"+ans+"</span>";
        p.onclick = () => handleAnswer(i);
        PLAT.appendChild(p);
    });
}

function handleAnswer(idx){
    clearInterval(timer);
    const q = LEVELS[lvlIdx].questions[qIdx];
    
    if(idx === q.correct){
        // Correct
        playAudio('ok');
        score += 100 + (combo*10);
        combo++;
        document.getElementById("SCORE").innerText = "‚≠ê " + score;
        document.getElementById("COMBO").classList.add("show");
        document.getElementById("COMBO_TXT").innerText = "x" + combo;
        
        FROG.classList.add("jump");
        setTimeout(()=>{
            FROG.classList.remove("jump");
            qIdx++;
            loadQuestion();
        }, 600);
    } else {
        // Wrong
        playAudio('bad');
        combo = 0;
        document.getElementById("COMBO").classList.remove("show");
        lives--;
        updateLives();
        
        const plats = document.querySelectorAll(".platform");
        if(idx !== -1 && plats[idx]) plats[idx].classList.add("wrong");
        
        if(lives <= 0) {
            showEnd(false);
        } else {
            setTimeout(()=>loadQuestion(), 1000);
        }
    }
}

function showEnd(win, grand=false){
    document.getElementById("END").classList.add("show");
    playAudio(win?'win':'lose');
    document.getElementById("END_TEXT").innerText = grand ? TEXTS.win : (win ? "Level Done" : TEXTS.lose);
    document.getElementById("END_TEXT").className = win ? "win" : "lose";
    document.getElementById("FINAL_SCORE").innerText = "Final Score: " + score;
    document.getElementById("NEXT_LEVEL").style.display = "none";
    document.getElementById("RETRY").style.display = "block";
}

<\/script>
</body>
</html>`;
}

function updatePreview() {
    const code = getGameHTML();
    document.getElementById('gameFrame').srcdoc = code;
}

function generateFinalCode() {
    const code = getGameHTML();
    document.getElementById('generated-code').value = code;
    document.getElementById('copy-overlay').style.display = 'flex';
}

function copyToClipboard() {
    const copyText = document.getElementById("generated-code");
    copyText.select();
    document.execCommand("copy");
    alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –í—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ Genially (Insert > Others).");
}

// Start
init();
</script>
</body>
</html>
